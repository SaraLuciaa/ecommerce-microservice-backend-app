name: CD - Main Deployment & Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: cd-main
  cancel-in-progress: true

jobs:
  security_scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Repo)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          output: 'trivy-repo-results.txt'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Print Trivy results
        if: always()
        run: cat trivy-repo-results.txt

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-repo-results-cd-main
          path: trivy-repo-results.txt

  build_and_analyze:
    name: Build, Test, JaCoCo & SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build, Test, Integration Test + JaCoCo
        run: |
          echo "Running full build and tests..."
          ./mvnw -B verify -Pintegration-tests

      - name: SonarCloud Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./mvnw -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=SaraLuciaa_ecommerce-microservice-backend-app \
            -Dsonar.organization=saraluciaa-ecommerce

  release:
    name: Create Tag & Release Notes
    runs-on: ubuntu-latest
    needs: build_and_analyze

    permissions:
      contents: write
      pull-requests: read

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine next version
        id: version
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          RELEASE_BRANCHES: main

      - name: Generate Release Notes
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: "Release ${{ steps.version.outputs.new_tag }}"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "Release created: ${{ steps.version.outputs.new_tag }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.new_tag }}"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build_and_analyze, release]
    
    steps:
      - name: Notify by Email on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "Pipeline FAILED - ${{ github.workflow }} / Job: ${{ github.job }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub CI/CD Bot <${{ secrets.EMAIL_USER }}>"
          body: |
            Pipeline failure detected

            Repository:  ${{ github.repository }}
            Branch:      ${{ github.ref_name }}
            Workflow:    ${{ github.workflow }}
            Job:         ${{ github.job }}
            Commit:      ${{ github.sha }}
            Autor:       ${{ github.actor }}
            URL:         https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Revisa los logs inmediatamente.
