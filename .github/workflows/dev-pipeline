name: Dev Environment - Build

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build_and_test:
    name: Build
    runs-on: ubuntu-latest

    steps:
      # 1. Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Detener contenedores previos
      - name: Stop existing containers
        run: |
          docker compose -f core.yml down || true
          docker compose -f compose.yml down || true

      # 3. Construir y levantar servicios base
      - name: Build and start core services
        run: |
          echo "üöß Building core services..."
          docker compose -f core.yml up -d --build

      # 4. Construir y levantar microservicios
      - name: Build and start microservices
        run: |
          echo "‚öôÔ∏è Building selected microservices..."
          docker compose -f compose.yml up -d --build

      # 5. Esperar arranque de contenedores
      - name: Wait for services
        run: |
          echo "‚åõ Waiting for containers to start..."
          sleep 20

      # 6. Verificar contenedores activos
      - name: List running containers
        run: docker ps -a

      # 7. Limpieza final
      - name: Clean up environment
        if: always()
        run: |
          echo "üßπ Cleaning environment..."
          docker compose -f compose.yml down
          docker compose -f core.yml down
